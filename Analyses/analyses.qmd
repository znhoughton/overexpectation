---
title: "analyses"
format: html
editor: visual
---

## Load data

```{r}
library(tidyverse)
library(brms)
data = read_csv('../Data/pilot_data3.csv')

#mouse3 --> dicrimination resp

#mouse3.corr --> discrimination accuracy
#mouse_4 --> test response after first training (in test_corr loop)
#mouse_4 --> test response after second training (in test_corr2 loop)
#mouse_4 --> test response after second training (in test_corr3 loop)
#mouse --> identification resp

data$mouse_phase <- dplyr::case_when(
  !is.na(data$`test_corr.thisTrialN`)  ~ "testcorr",
  !is.na(data$`test_corr2.thisTrialN`) ~ "testcorr2",
  !is.na(data$`test_corr3.thisTrialN`) ~ "testcorr3",
  !is.na(data$`discrimination.thisTrialN`) ~ "discrimination",
  !is.na(data$`ident.thisTrialN`) ~ "identification",
  !is.na(data$`trials.thisN`) ~ "training",
  !is.na(data$`train2.thisN`) ~ "training2",
  !is.na(data$`train3.thisN`) ~ "training3",
  TRUE ~ NA_character_
)


data_filtered = data %>%
  select(participant, date, mouse_3.clicked_name, mouse_3.x, mouse_3.y, mouse_3.corr, mouse.clicked_name, mouse_4.clicked_name, mouse_phase, Picture1, Picture2, TestPicture1, TestPicture2, Sound, Sound1) %>%
  mutate(Sound = coalesce(Sound, Sound1)) %>%
  mutate(Picture1 = coalesce(Picture1, TestPicture1)) %>%
  mutate(Picture2 = coalesce(Picture2, TestPicture2)) %>%
  mutate(resp = coalesce(mouse_3.clicked_name, mouse.clicked_name, mouse_4.clicked_name)) %>%
  mutate(resp = case_when(
    str_detect(resp, "textbox_8") ~ "wrong",
    str_detect(resp, "textbox_7") ~ "correct",
    TRUE ~ resp
)) %>%
  select(-Sound1, -TestPicture1, -TestPicture2, -mouse_3.clicked_name, -mouse.clicked_name, -mouse_4.clicked_name) %>%
  mutate(condition = case_when(
    str_detect(Sound, "LoudnessManipulation") ~ 'Loudness',
    str_detect(Sound, "PitchManipulation") ~ 'Pitch',
    .default = 'F0'
  ))

data_filtered = data_filtered %>%
  mutate(trial_type = case_when(
    Picture1 == "A.PNG" & Picture2 == "A.PNG" ~ "AA",
    Picture1 == "A.PNG" | Picture2 == "A.PNG" ~ "A",
    is.na(Picture1) | is.na(Picture2) ~ NA_character_,
    TRUE ~ "No A"
  ))

data_test = data_filtered %>%
  select(participant, date)

```

We should filter out data after 11/26/2025

```{r}
# data_test$date = as.Date(data_test$date)
# 
# cutoff = ymd("2025-11-25")
# 
# data_filtered = data_test %>%
#   filter(date > cutoff)
```
# TestCorr vs TestCorr1 vs TestCorr2

```{r}
data_testcorrs = data_filtered %>%
  filter(mouse_phase %in% c("testcorr", "testcorr2", "testcorr3")) 
```

190, 215, 240 

Training for tests1 and 2 are identical, but test2 tests for AA in addition to just A (whereas test1 does not).

training for test 3 includes AA, and so we should potentially see a difference here
## 

```{r}
data_testcorrs_f0 = data_testcorrs %>%
  filter(condition == "F0") %>%
  mutate(across(where(is.character), ~ na_if(.x, "[null]")))

data_testcorrs_f0 = data_testcorrs_f0 %>%
  mutate(resp = case_when(
    resp == "correct" ~ 1,
    resp == "wrong" ~ 0,
    TRUE ~ NA_real_
  ))

data_testcorrs_f0$resp = factor(data_testcorrs_f0$resp)

data_testcorrs_loudness = data_testcorrs %>%
  filter(condition == "Loudness") %>%
  mutate(across(where(is.character), ~ na_if(.x, "[null]")))

data_testcorrs_loudness = data_testcorrs_loudness %>%
  mutate(resp = case_when(
    resp == "correct" ~ 1,
    resp == "wrong" ~ 0,
    TRUE ~ NA_real_
  ))

data_testcorrs_loudness$resp = factor(data_testcorrs_loudness$resp)

data_testcorrs_pitch = data_testcorrs %>%
  filter(condition == "Pitch") %>%
  mutate(across(where(is.character), ~ na_if(.x, "[null]")))

data_testcorrs_pitch = data_testcorrs_pitch %>%
  mutate(resp = case_when(
    resp == "correct" ~ 1,
    resp == "wrong" ~ 0,
    TRUE ~ NA_real_
  ))

data_testcorrs_pitch$resp = factor(data_testcorrs_pitch$resp)

m1_f0 = brm(
  resp ~ Sound * trial_type * mouse_phase + (1|participant),
  data = data_testcorrs_f0,
  family = bernoulli(),
  prior = c(
    prior(normal(0, 1), class = "b"),
    prior(normal(0, 1), class = "Intercept")
  ),
  iter = 4000,
  warmup = 1000,
  chains = 4,
  cores = 4,
  seed = 123
)

m1_loudness = brm(
  resp ~ Sound * trial_type * mouse_phase + (1|participant),
  data = data_testcorrs_loudness,
  family = bernoulli(),
  prior = c(
    prior(normal(0, 1), class = "b"),
    prior(normal(0, 1), class = "Intercept")
  ),
  iter = 4000,
  warmup = 1000,
  chains = 4,
  cores = 4,
  seed = 123
)

m1_pitch = brm(
  resp ~ Sound * trial_type * mouse_phase + (1|participant),
  data = data_testcorrs_pitch,
  family = bernoulli(),
  prior = c(
    prior(normal(0, 1), class = "b"),
    prior(normal(0, 1), class = "Intercept")
  ),
  iter = 4000,
  warmup = 1000,
  chains = 4,
  cores = 4,
  seed = 123
)

uo_green  <- "#154734"  # UO Green
uo_yellow <- "#FEE123"  # UO Yellow
uo_gray   <- "#C4C4C4"


ce <- conditional_effects(
  m1_f0,
  effects = "Sound:trial_type",
  conditions = data.frame(
    mouse_phase = unique(data_testcorrs_f0$mouse_phase)
  )
)

ce_loudness <- conditional_effects(
  m1_loudness,
  effects = "Sound:trial_type",
  conditions = data.frame(
    mouse_phase = unique(data_testcorrs_f0$mouse_phase)
  )
)


ce_pitch <- conditional_effects(
  m1_pitch,
  effects = "Sound:trial_type",
  conditions = data.frame(
    mouse_phase = unique(data_testcorrs_f0$mouse_phase)
  )
)


p <- plot(ce, plot = FALSE)[[1]] +
  theme_bw(base_size = 16) +
  scale_color_manual(
    values = c(
      "A" = uo_green,
      "B" = uo_yellow
    )
  ) +
  scale_fill_manual(
    values = c(
      "A" = uo_green,
      "B" = uo_yellow
    )
  ) +
  theme(
    panel.grid.major = element_line(color = "grey85", linewidth = 0.3),
    panel.grid.minor = element_blank(),

    legend.position = "top",
    legend.title = element_text(face = "bold"),
    legend.text = element_text(size = 13),

    axis.title = element_text(face = "bold"),
    strip.background = element_rect(fill = uo_green, color = NA),
    strip.text = element_text(color = "white", face = "bold")
  ) +
  labs(
    x = "Sound",
    y = "Predicted probability",
    color = "Trial type",
    fill  = "Trial type"
  )

```

Run analysis on Test2, filter for sounds 240 vs 290 and A vs AA trials (filter out not A trials)

See if participants show overexpectation ()



```{r}
data_testcorr2_f0 = data_testcorrs %>%
  filter(condition == "F0", mouse_phase == "testcorr2") %>%
  mutate(across(where(is.character), ~ na_if(.x, "[null]"))) 

data_testcorr2_f0 = data_testcorr2_f0 %>%
  filter(str_detect(Sound, "240") | str_detect(Sound, "290")) %>%
  filter(trial_type %in% c("A", "AA")) %>%
  mutate(resp = case_when(
    resp == "correct" ~ 1,
    resp == "wrong" ~ 0,
    TRUE ~ NA_real_
  ))

data_testcorr_loudness = data_testcorrs %>%
  filter(condition == "Loudness", mouse_phase == "testcorr2") %>%
  mutate(across(where(is.character), ~ na_if(.x, "[null]")))

data_testcorr_loudness = data_testcorr_loudness %>%
  filter(str_detect(Sound, "240") | str_detect(Sound, "290")) %>%
  filter(trial_type %in% c("A", "AA")) %>%
  mutate(resp = case_when(
    resp == "correct" ~ 1,
    resp == "wrong" ~ 0,
    TRUE ~ NA_real_
  ))

data_testcorr_pitch = data_testcorrs %>%
  filter(condition == "Pitch", mouse_phase == "testcorr2") %>%
  mutate(across(where(is.character), ~ na_if(.x, "[null]")))

data_testcorr_pitch = data_testcorr_pitch %>%
  filter(str_detect(Sound, "240") | str_detect(Sound, "290")) %>%
  filter(trial_type %in% c("A", "AA")) %>%
  mutate(resp = case_when(
    resp == "correct" ~ 1,
    resp == "wrong" ~ 0,
    TRUE ~ NA_real_
  ))

m2_f0 = brm(
  resp ~ Sound * trial_type + (1 + Sound * trial_type |participant),
  data = data_testcorr2_f0,
  family = bernoulli(),
  prior = c(
    prior(normal(0, 1), class = "b"),
    prior(normal(0, 1), class = "Intercept")
  ),
  iter = 4000,
  warmup = 1000,
  chains = 4,
  cores = 4,
  seed = 123
)

m2_loudness = brm(
  resp ~ Sound * trial_type + (1 + Sound * trial_type |participant),
  data = data_testcorr_loudness,
  family = bernoulli(),
  prior = c(
    prior(normal(0, 1), class = "b"),
    prior(normal(0, 1), class = "Intercept")
  ),
  iter = 4000,
  warmup = 1000,
  chains = 4,
  cores = 4,
  seed = 123
)

m2_pitch = brm(
  resp ~ Sound * trial_type + (1 + Sound * trial_type |participant),
  data = data_testcorr_pitch,
  family = bernoulli(),
  prior = c(
    prior(normal(0, 1), class = "b"),
    prior(normal(0, 1), class = "Intercept")
  ),
  iter = 4000,
  warmup = 1000,
  chains = 4,
  cores = 4,
  seed = 123
)

re <- ranef(m2_f0)$participant
str(re)

re_tidy <- coef(m2_f0)$participant %>%
  as.data.frame() %>%
  tibble::rownames_to_column("participant") %>%
  janitor::clean_names()



re_long <- re_tidy %>%
  pivot_longer(
    cols = matches("estimate|q2_5|q97_5"),
    names_to = c(".value", "term"),
    names_pattern = "(estimate|q2_5|q97_5)_(.*)"
  )

re_long %>%
  ggplot(aes(x = participant,
             y = estimate,
             ymin = q2_5,
             ymax = q97_5)) +
  geom_pointrange() +
  coord_flip() +
  facet_wrap(~ term, scales = "free_y") +
  theme_bw()


# re_long %>%
#   filter(term == "soundbp_290_25_wav_trial_type_aa") %>%
#   ggplot(aes(x = reorder(participant, estimate),
#              y = estimate,
#              ymin = q2_5,
#              ymax = q97_5)) +
#   geom_pointrange() +
#   coord_flip() +
#   theme_bw()

re_loudness <- ranef(m2_loudness)$participant
str(re)

re_tidy_loudness <- coef(m2_loudness)$participant %>%
  as.data.frame() %>%
  tibble::rownames_to_column("participant") %>%
  janitor::clean_names()



re_long_loudness <- re_tidy_loudness %>%
  pivot_longer(
    cols = matches("estimate|q2_5|q97_5"),
    names_to = c(".value", "term"),
    names_pattern = "(estimate|q2_5|q97_5)_(.*)"
  )

re_long_loudness %>%
  ggplot(aes(x = participant,
             y = estimate,
             ymin = q2_5,
             ymax = q97_5)) +
  geom_pointrange() +
  coord_flip() +
  facet_wrap(~ term, scales = "free_y") +
  theme_bw()


re_pitch <- ranef(m2_pitch)$participant
str(re)

re_tidy_pitch <- coef(m2_pitch)$participant %>%
  as.data.frame() %>%
  tibble::rownames_to_column("participant") %>%
  janitor::clean_names()



re_long_pitch <- re_tidy_pitch %>%
  pivot_longer(
    cols = matches("estimate|q2_5|q97_5"),
    names_to = c(".value", "term"),
    names_pattern = "(estimate|q2_5|q97_5)_(.*)"
  )

re_long_pitch %>%
  ggplot(aes(x = participant,
             y = estimate,
             ymin = q2_5,
             ymax = q97_5)) +
  geom_pointrange() +
  coord_flip() +
  facet_wrap(~ term, scales = "free_y") +
  theme_bw()

```

third test:

```{r}

data_testcorr3_f0 = data_testcorrs %>%
  filter(condition == "F0", mouse_phase == "testcorr3") %>%
  mutate(across(where(is.character), ~ na_if(.x, "[null]"))) 


data_testcorr3_f0 = data_testcorr3_f0 %>%
  filter(str_detect(Sound, "240") | str_detect(Sound, "290")) %>%
  filter(trial_type %in% c("A", "AA")) %>%
  mutate(resp = case_when(
    resp == "correct" ~ 1,
    resp == "wrong" ~ 0,
    TRUE ~ NA_real_
  ))

data_testcorr3_loudness = data_testcorrs %>%
  filter(condition == "Loudness", mouse_phase == "testcorr3") %>%
  mutate(across(where(is.character), ~ na_if(.x, "[null]")))

data_testcorr3_loudness = data_testcorr3_loudness %>%
  filter(str_detect(Sound, "240") | str_detect(Sound, "290")) %>%
  filter(trial_type %in% c("A", "AA")) %>%
  mutate(resp = case_when(
    resp == "correct" ~ 1,
    resp == "wrong" ~ 0,
    TRUE ~ NA_real_
  ))

data_testcorr3_pitch = data_testcorrs %>%
  filter(condition == "Pitch", mouse_phase == "testcorr3") %>%
  mutate(across(where(is.character), ~ na_if(.x, "[null]")))

data_testcorr3_pitch = data_testcorr3_pitch %>%
  filter(str_detect(Sound, "240") | str_detect(Sound, "290")) %>%
  filter(trial_type %in% c("A", "AA")) %>%
  mutate(resp = case_when(
    resp == "correct" ~ 1,
    resp == "wrong" ~ 0,
    TRUE ~ NA_real_
  ))

m2_f03 = brm(
  resp ~ Sound * trial_type + (1 + Sound * trial_type |participant),
  data = data_testcorr2_f0,
  family = bernoulli(),
  prior = c(
    prior(normal(0, 1), class = "b"),
    prior(normal(0, 1), class = "Intercept")
  ),
  iter = 4000,
  warmup = 1000,
  chains = 4,
  cores = 4,
  seed = 123
)

m2_loudness3 = brm(
  resp ~ Sound * trial_type + (1 + Sound * trial_type |participant),
  data = data_testcorr_loudness,
  family = bernoulli(),
  prior = c(
    prior(normal(0, 1), class = "b"),
    prior(normal(0, 1), class = "Intercept")
  ),
  iter = 4000,
  warmup = 1000,
  chains = 4,
  cores = 4,
  seed = 123
)

m2_pitch3 = brm(
  resp ~ Sound * trial_type + (1 + Sound * trial_type |participant),
  data = data_testcorr_pitch,
  family = bernoulli(),
  prior = c(
    prior(normal(0, 1), class = "b"),
    prior(normal(0, 1), class = "Intercept")
  ),
  iter = 4000,
  warmup = 1000,
  chains = 4,
  cores = 4,
  seed = 123
)



re3 <- ranef(m2_f03)$participant
str(re3)

re_tidy3 <- coef(m2_f03)$participant %>%
  as.data.frame() %>%
  tibble::rownames_to_column("participant") %>%
  janitor::clean_names()



re_long3 <- re_tidy3 %>%
  pivot_longer(
    cols = matches("estimate|q2_5|q97_5"),
    names_to = c(".value", "term"),
    names_pattern = "(estimate|q2_5|q97_5)_(.*)"
  )

re_long3 %>%
  ggplot(aes(x = participant,
             y = estimate,
             ymin = q2_5,
             ymax = q97_5)) +
  geom_pointrange() +
  coord_flip() +
  facet_wrap(~ term, scales = "free_y") +
  theme_bw()


# re_long %>%
#   filter(term == "soundbp_290_25_wav_trial_type_aa") %>%
#   ggplot(aes(x = reorder(participant, estimate),
#              y = estimate,
#              ymin = q2_5,
#              ymax = q97_5)) +
#   geom_pointrange() +
#   coord_flip() +
#   theme_bw()

re_loudness3 <- ranef(m2_loudness3)$participant


re_tidy_loudness3 <- coef(m2_loudness3)$participant %>%
  as.data.frame() %>%
  tibble::rownames_to_column("participant") %>%
  janitor::clean_names()



re_long_loudness3 <- re_tidy_loudness3 %>%
  pivot_longer(
    cols = matches("estimate|q2_5|q97_5"),
    names_to = c(".value", "term"),
    names_pattern = "(estimate|q2_5|q97_5)_(.*)"
  )

re_long_loudness3 %>%
  ggplot(aes(x = participant,
             y = estimate,
             ymin = q2_5,
             ymax = q97_5)) +
  geom_pointrange() +
  coord_flip() +
  facet_wrap(~ term, scales = "free_y") +
  theme_bw()


re_pitch3 <- ranef(m2_pitch3)$participant
str(re)

re_tidy_pitch3 <- coef(m2_pitch3)$participant %>%
  as.data.frame() %>%
  tibble::rownames_to_column("participant") %>%
  janitor::clean_names()



re_long_pitch3 <- re_tidy_pitch3 %>%
  pivot_longer(
    cols = matches("estimate|q2_5|q97_5"),
    names_to = c(".value", "term"),
    names_pattern = "(estimate|q2_5|q97_5)_(.*)"
  )

re_long_pitch3 %>%
  ggplot(aes(x = participant,
             y = estimate,
             ymin = q2_5,
             ymax = q97_5)) +
  geom_pointrange() +
  coord_flip() +
  facet_wrap(~ term, scales = "free_y") +
  theme_bw()

```
### Plots

```{r}

library(dplyr)
library(ggplot2)
library(forcats)
library(stringr)
library(scales)

data_testcorrs_clean <- data_testcorrs %>%
  mutate(
    across(where(is.character), ~ na_if(.x, "[null]")),
    sound_file = str_extract(Sound, "bp_[0-9]+_[0-9]+\\.wav")
  ) %>%
  left_join(
    pitch_map,
    by = c("sound_file" = "Sound")
  ) %>%
  filter(!is.na(pitch_cat)) %>%
  mutate(
  mouse_phase = recode(
    mouse_phase,
    "testcorr"  = "1",
    "testcorr2" = "2",
    "testcorr3" = "3"
  ),
  mouse_phase = factor(mouse_phase, levels = c("1", "2", "3"))
)


data_testcorrs_clean <- data_testcorrs_clean %>%
  mutate(
    condition = factor(
      condition,
      levels = c("F0", "Loudness", "Pitch")
    )
  )

data_testcorrs_clean <- data_testcorrs_clean %>%
  mutate(
    is_correct = resp == "correct"
  )

data_testcorrs_clean <- data_testcorrs_clean %>%
  mutate(
    pitch_cat = factor(
      pitch_cat,
      levels = c("Low", "Medium", "High", "Superhigh"),
      ordered = TRUE
    )
  )




condition_labs <- c(
  F0 = "F0",
  Loudness = "Loudness",
  Pitch = "Pitch"
)

# University of Oregon colors
uo_yellow_low   <- "#FFE066"  # Low (noticeably yellow, readable)
uo_yellow_med   <- "#F5C400"  # Medium (gold / darker yellow)
uo_green_light  <- "#6BAF92"  # High (light green)
uo_green_dark   <- "#154734"  # Superhigh (UO green)



pitch_map <- tibble(
  Sound = c(
    "bp_190_25.wav",
    "bp_215_25.wav",
    "bp_240_25.wav",
    "bp_290_25.wav"
  ),
  pitch_cat = c(
    "Low",
    "Medium",
    "High",
    "Superhigh"
  )
)


plot_accuracy_props_grid <- function(df, choices, stages = NULL) {
  df %>%
    { if (!is.null(stages))
        dplyr::filter(., mouse_phase %in% stages)
      else .
    } %>%
    mutate(
      mouse_phase = droplevels(mouse_phase)   # âœ… THIS LINE
    ) %>%
    filter(pitch_cat %in% choices & trial_type != "No A") %>%
    group_by(mouse_phase, condition, trial_type, pitch_cat) %>%
    summarise(
      n_trials  = n(),
      n_correct = sum(is_correct, na.rm = TRUE),
      .groups = "drop"
    ) %>%
    complete(
      mouse_phase,
      condition,
      trial_type,
      pitch_cat,
      fill = list(
        n_trials  = 0,
        n_correct = 0
      )
    ) %>%
    mutate(
      prop_correct = if_else(n_trials > 0, n_correct / n_trials, 0),
      ci = purrr::map2(
        n_correct, n_trials,
        ~ if (.y > 0) binom.test(.x, .y)$conf.int else c(0, 0)
      ),
      ci_low  = purrr::map_dbl(ci, 1),
      ci_high = purrr::map_dbl(ci, 2)
    ) %>%
    ggplot(aes(
      x = trial_type,
      y = prop_correct,
      fill = pitch_cat
    )) +
    geom_col(
      position = position_dodge(width = 0.7),
      width = 0.7
    ) +
    geom_errorbar(
      aes(ymin = ci_low, ymax = ci_high),
      position = position_dodge(width = 0.7),
      width = 0.2,
      linewidth = 0.6
    ) +
    facet_grid(
      mouse_phase ~ condition,
      labeller = labeller(
        mouse_phase = c("1"="Stage 1","2"="Stage 1","3"="Stage 2"), #confusingly gonna name Stage 2 as stage 1
        condition   = c("F0"="F0 as Voicing","Loudness"="Loudness","Pitch"="F0 as Pitch")
      )
    ) +
    scale_y_continuous(labels = scales::percent, limits = c(0, 1)) +
    scale_fill_manual(
      values = c(
        Low       = uo_yellow_low,
        Medium    = uo_yellow_med,
        High      = uo_green_light,
        Superhigh = uo_green_dark
      )
    )    +
    theme_bw(base_size = 15) +
    theme(
      panel.grid.major.x = element_blank(),
      panel.grid.minor = element_blank(),
      legend.position = "top",
      legend.title = element_text(face = "bold"),
      strip.background = element_rect(fill = uo_green),
      strip.text = element_text(color = "white", face = "bold"),
      axis.title = element_text(face = "bold"),
      axis.text.x = element_text(angle = 30, hjust = 1)
    ) +
    labs(
      x = "Creature Type",
      y = "Proportion Chosen",
      fill = "Sound Category"
    )
}




conditions <- c("F0", "Loudness", "Pitch")
```

```{r}


plot_accuracy_props_grid(
  data_testcorrs_clean,
  choices = c("Low", "Medium", "High", "Superhigh"),
  stages = c("2", "3"))


```


